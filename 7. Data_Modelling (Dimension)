//CREATING FACT AND DIMENTION TABLE
USE ROLE ACCOUNTADMIN;
USE WAREHOUSE COMPUTE_WH;
USE SCHEMA CRICKET.CONSUMPTION

create or replace table date_dim (
    date_id int primary key autoincrement,
    full_dt date,
    day int,
    month int,
    year int,
    quarter int,
    dayofweek int,
    dayofmonth int,
    dayofyear int,
    dayofweekname varchar(3), -- to store day names (e.g., "Mon")
    isweekend boolean -- to indicate if it's a weekend (True/False Sat/Sun both falls under weekend)
);

--match referees, reserve_impires, tv_impires, filed_umpires
create or replace table referee_dim (
    referee_id int primary key autoincrement,
    referee_name text not null,
    referee_type text not null
);

--team table; team_id, team_name
create or replace table team_dim (
    team_id int primary key autoincrement,
    team_name text not null
);

--player table; player_id, team_id, player_name
create or replace table player_dim (
    player_id int primary key autoincrement,
    team_id int not null,
    player_name text not null
);

--create relationship between team and player dimention tables
alter table cricket.consumption.player_dim
add constraint fk_team_player_id
foreign key (team_id)
references cricket.consumption.team_dim (team_id);

--create venue dimention table
create or replace table venue_dim (
    venue_id int primary key autoincrement,
    venue_name text not null,
    city text not null,
    state text,
    country text,
    continent text,
    end_Names text,
    capacity number,
    pitch text,
    flood_light boolean,
    established_dt date,
    playing_area text,
    other_sports text,
    curator text,
    lattitude number(10,6),
    longitude number(10,6)
);

--create match dimention table with only match_type_id and match_type
create or replace table match_type_dim (
    match_type_id int primary key autoincrement,
    match_type text not null
);

--Create Match_fact table consolidating all the dimentio tables into one with foreign keys and constraint
CREATE or replace TABLE match_fact (
    match_id INT PRIMARY KEY,
    date_id INT NOT NULL,
    referee_id INT NOT NULL,
    team_a_id INT NOT NULL,
    team_b_id INT NOT NULL,
    match_type_id INT NOT NULL,
    venue_id INT NOT NULL,
    total_overs number(3),
    balls_per_over number(1),

    overs_played_by_team_a number(2),
    bowls_played_by_team_a number(3),
    extra_bowls_played_by_team_a number(3),
    extra_runs_scored_by_team_a number(3),
    fours_by_team_a number(3),
    sixes_by_team_a number(3),
    total_score_by_team_a number(3),
    wicket_lost_by_team_a number(2),

    overs_played_by_team_b number(2),
    bowls_played_by_team_b number(3),
    extra_bowls_played_by_team_b number(3),
    extra_runs_scored_by_team_b number(3),
    fours_by_team_b number(3),
    sixes_by_team_b number(3),
    total_score_by_team_b number(3),
    wicket_lost_by_team_b number(2),

    toss_winner_team_id int not null, 
    toss_decision text not null, 
    match_result text not null, 
    winner_team_id int not null,

    CONSTRAINT fk_date FOREIGN KEY (date_id) REFERENCES date_dim (date_id),
    CONSTRAINT fk_referee FOREIGN KEY (referee_id) REFERENCES referee_dim (referee_id),
    CONSTRAINT fk_team1 FOREIGN KEY (team_a_id) REFERENCES team_dim (team_id),
    CONSTRAINT fk_team2 FOREIGN KEY (team_b_id) REFERENCES team_dim (team_id),
    CONSTRAINT fk_match_type FOREIGN KEY (match_type_id) REFERENCES match_type_dim (match_type_id),
    CONSTRAINT fk_venue FOREIGN KEY (venue_id) REFERENCES venue_dim (venue_id),

    CONSTRAINT fk_toss_winner_team FOREIGN KEY (toss_winner_team_id) REFERENCES team_dim (team_id),
    CONSTRAINT fk_winner_team FOREIGN KEY (winner_team_id) REFERENCES team_dim (team_id)
);

--populating data into the team diemntion table
INSERT INTO CRICKET.CONSUMPTION.TEAM_DIM(team_name)
SELECT DISTINCT team_name FROM (
    SELECT first_team as team_name from CRICKET.CLEAN.MATCH_DETAIL_CLEAN
    UNION ALL
    SELECT second_team as team_name from CRICKET.CLEAN.MATCH_DETAIL_CLEAN
)
order by team_name;

--check the table
select * from CRICKET.CONSUMPTION.TEAM_DIM;


--populating data into the team player diemntion table
INSERT INTO CRICKET.CONSUMPTION.PLAYER_DIM(team_id, player_name)
SELECT 
    T.team_id,
    P.player_name
FROM
    CRICKET.CLEAN.PLAYER_CLEAN_TBL P 
    JOIN
    CRICKET.CONSUMPTION.TEAM_DIM T
    ON 
    P.COUNTRY = T.TEAM_NAME
GROUP BY
    T.team_id,
    P.player_name;

--check the table
select * from CRICKET.CONSUMPTION.PLAYER_DIM
ORDER BY 1


-- create a venue diemntion table 
INSERT INTO CRICKET.CONSUMPTION.VENUE_DIM(venue_name,city)
SELECT
    venue,city 
    FROM (
        SELECT 
            venue,
            case when city is null then 'NA'
            else city
            end as city
        FROM
            cricket.clean.match_detail_clean
    )
GROUP BY 
    venue,
    city;

-- check out the venue table
SELECT * FROM CRICKET.CONSUMPTION.VENUE_DIM


--populate the match_type dimention table
INSERT INTO CRICKET.CONSUMPTION.MATCH_TYPE_DIM(match_type)
SELECT match_type 
FROM
CRICKET.CLEAN.MATCH_DETAIL_CLEAN 
GROUP BY MATCH_TYPE;

SELECT * FROM CRICKET.CONSUMPTION.MATCH_TYPE_DIM;
